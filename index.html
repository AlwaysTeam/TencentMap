<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="./images/favicon.ico" />
    <title>腾讯地图</title>
    <script type="text/javascript">
      window._TMapSecurityConfig = {
        serviceHost: "https://static.zhangsifan.com/_TMapService",
      };
    </script>
    <script src="https://map.qq.com/api/gljs?v=1.exp&libraries=service"></script>
    <script src="https://mapapi.qq.com/web/lbs/h5-components/geolocation/geolocation.min.js"></script>
    <style>
      html,
      body {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
      }
      #container {
        width: 100%;
        height: 100%;
        overflow: hidden;
      }
      .container {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
      }
      .btnContainer {
        position: absolute;
        left: 20px;
        top: 20px;
        z-index: 10000;
      }
      .btnContainer button {
        padding: 10px 14px;
        box-sizing: border-box;
        border: none;
        background-color: #919aac;
        border-radius: 2px;
        color: #fff;
        font-size: 14px;
        line-height: 14px;
        cursor: pointer;
      }
    </style>
  </head>
  <body onLoad="initMap()">
    <div class="btnContainer">
      <button onClick="window.open('./car_track.html','_blank')">
        车辆轨迹
      </button>
      <button onClick="window.open('./planning.html','_blank')">
        路径规划
      </button>
    </div>
    <div id="container"></div>
    <script>
      function initMap() {
        var map = new TMap.Map(document.getElementById("container"), {
          center: new TMap.LatLng(39.9069659960541, 116.39749745438792),
          zoom: 15,
        });

        getLocation();

        var markerLayer = new TMap.MultiMarker({
          map: map,
          styles: {
            myStyle: new TMap.MarkerStyle({
              width: 25,
              height: 35,
              anchor: { x: 16, y: 32 },
            }),
          },
          geometries: [],
        });

        map.on("click", (evt) => {
          addMarker(evt.latLng.lat, evt.latLng.lng);
          console.log(
            "点击位置的经纬度为：" + evt.latLng.lat + "," + evt.latLng.lng
          );
        });

        function addMarker(lat, lng) {
          markerLayer.setGeometries([]);
          markerLayer.add({
            position: new TMap.LatLng(lat, lng),
          });
          map.setCenter(new TMap.LatLng(lat, lng));
        }
        function getLocation() {
          const geoInstance = new window.LBS.WebComponent.Geolocation({
            domain: "https://static.zhangsifan.com/_TMapService/service",
            referer: "h5-geolocation-demo-4",
          });
          geoInstance.getLocation(
            (result) => {
              addMarker(result.lat, result.lng);
              console.log(
                "浏览器位置的经纬度为：" + result.lat + "," + result.lng
              );
            },
            (error) => {
              console.log("浏览器获取位置失败，使用IP定位");
              ipInfo();
            },
            { timeout: 6000, highAccuracy: true }
          );
        }
        function ipInfo() {
          fetch("https://api.zhangsifan.com/utils/getipinfo")
            .then((response) => response.json())
            .then((data) => {
              var ipLocation = new TMap.service.IPLocation();
              ipLocation
                .locate({
                  ip: data.result.ip,
                })
                .then(({ result }) => {
                  addMarker(result.location.lat, result.location.lng);
                  console.log(
                    "IP位置的经纬度为：" +
                      result.location.lat +
                      "," +
                      result.location.lng
                  );
                });
            })
            .catch((error) =>
              console.error("Error fetching IP location:", error)
            );
        }
      }
    </script>
  </body>
</html>
