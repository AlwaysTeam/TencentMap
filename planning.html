<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="./images/favicon.ico" />
    <title>规划路径 - 腾讯地图</title>
  </head>
  <script type="text/javascript">
    window._TMapSecurityConfig = {
      serviceHost: "https://static.zhangsifan.com/_TMapService",
    };
  </script>
  <script src="https://map.qq.com/api/gljs?v=1.exp"></script>
  <script src="./js/planningData.js"></script>
  <style>
    html,
    body {
      height: 100%;
      margin: 0px;
      padding: 0px;
      overflow: hidden;
    }

    #mapContainer {
      position: relative;
      width: 100%;
      height: 100%;
    }
  </style>

  <body onload="initMap()">
    <div id="mapContainer"></div>
  </body>
</html>
<script>
  var map;
  function initMap() {
    map = new TMap.Map("mapContainer", {
      center: new TMap.LatLng(39.9069659960541, 116.39749745438792),
      zoom: 15,
    });

    const control = map.getControl(TMap.constants.DEFAULT_CONTROL_ID.ZOOM);
    control.setNumVisible(true);

    drawPath(planningData.result.routes[0]);
  }

  function drawPath(routes) {
    var coords = routes.polyline;
    let pl = [];

    //坐标解压（返回的点串坐标，通过前向差分进行压缩）
    var kr = 1000000;
    for (var i = 2; i < coords.length; i++) {
      coords[i] = Number(coords[i - 2]) + Number(coords[i]) / kr;
    }
    //将解压后的坐标放入点串数组pl中
    for (var i = 0; i < coords.length; i += 2) {
      pl.push(new TMap.LatLng(coords[i], coords[i + 1]));
    }

    let geometries = [
      {
        id: "start",
        styleId: "start",
        position: pl[0],
      },
      {
        id: "end",
        styleId: "end",
        position: pl[pl.length - 1],
      },
    ];
    routes.waypoints.forEach((item, index) => {
      geometries.splice(index + 1, 0, {
        id: "mid" + index,
        styleId: "mid",
        position: new TMap.LatLng(item.location.lat, item.location.lng),
      });
    });

    var latlngBounds = new TMap.LatLngBounds();
    for (var i = 0; i < pl.length; i++) {
      latlngBounds.extend(pl[i]);
    }
    map.fitBounds(latlngBounds, {
      padding: 100,
    });

    var polylineLayer = new TMap.MultiPolyline({
      id: "polyline-layer",
      map: map,
      styles: {
        style_blue: new TMap.PolylineStyle({
          color: "#3777FF", //线填充色
          width: 8, //折线宽度
          borderWidth: 5, //边线宽度
          borderColor: "#FFF", //边线颜色
          lineCap: "round", //线端头方式
        }),
      },
      geometries: [
        {
          id: "pl_1", //折线唯一标识，删除时使用
          styleId: "style_blue", //绑定样式名
          paths: pl,
        },
      ],
    });

    var marker = new TMap.MultiMarker({
      id: "marker-layer",
      map: map,
      styles: {
        start: new TMap.MarkerStyle({
          width: 25,
          height: 35,
          anchor: { x: 16, y: 32 },
          src: "https://webapi.amap.com/theme/v1.3/markers/b/start.png",
        }),
        mid: new TMap.MarkerStyle({
          width: 25,
          height: 35,
          anchor: { x: 16, y: 32 },
          src: "https://webapi.amap.com/theme/v1.3/markers/b/mid.png",
        }),
        end: new TMap.MarkerStyle({
          width: 25,
          height: 35,
          anchor: { x: 16, y: 32 },
          src: "https://webapi.amap.com/theme/v1.3/markers/b/end.png",
        }),
      },
      geometries: geometries,
    });
  }
</script>
